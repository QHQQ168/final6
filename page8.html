<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é£ç­æ”¾é£æ‹æ‘„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            font-family: "Noto Sans SC Regular", sans-serif;
        }
        body {
            background-image: url("images/2/background.jpg");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* ========== é€šç”¨å®¹å™¨æ ·å¼ï¼ˆç»Ÿä¸€å®½é«˜æ¯”ï¼Œå…³é”®ï¼ï¼‰ ========== */
        .camera-view, .preview-box, .final-photo-area {
            position: absolute;
            top: 10vh;          
            left: 10vw;
            width: 80vw;
            height: 75vh;      
            border: 4px solid #a8d08d;
            background-color: #fff8e6;
            overflow: hidden; 
            z-index: 1;
            /* å›ºå®šå®½é«˜æ¯”ï¼Œå’Œç›¸æœºå®¹å™¨å®Œå…¨ä¸€è‡´ */
            aspect-ratio: 80/75;
            max-height: 80vh;  
        }

        /* ========== ç¬¬ä¸€é¡µï¼ˆæ‹æ‘„é¡µï¼‰ ========== */
        #shoot-page {
            display: block;
            width: 100%;
            height: 100%;
        }
        #camera-preview {
            object-fit: cover; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: none;
        }
        #kite-tail-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 1;
        }
        #kite-img {
            position: absolute;
            top: 48vh;         
            left: 15vw;
            transform: rotate(15deg);
            width: 80vw;
            height: auto; 
            cursor: pointer;
            z-index: 2;
            transition: all 0.2s;
            max-width: 50vw;
            max-height: 40vh;
            object-fit: contain; 
            image-rendering: auto;
        }
        @keyframes kiteFlyCurve {
            0% {
                top:48vh;       
                left: 15vw;
                transform: rotate(15deg) scale(1);
            }
            25% {
                top: 40vh;      
                left:25vw;
                transform: rotate(20deg) scale(0.95);
            }
            50% {
                top: 34vh;      
                left: 35vw;
                transform: rotate(25deg) scale(0.83);
            }
            75% {
                top: 28vh;      
                left: 42vw;
                transform: rotate(20deg) scale(0.78);
            }
            100% {
                top: 16vh;      
                left: 40vw;
                transform: rotate(15deg) scale(0.76);
            }
        }
        @keyframes kiteFloat {
            0% { top: 16vh; }  
            50% { top: 20vh; }
            100% { top: 16vh; }
        }
        .flying {
            animation: 
                kiteFlyCurve 2.5s ease-out forwards, 
                kiteFloat 1.5s infinite ease-in-out 2.5s;
        }
        .hint {
            position: absolute;
            top: 11vh;         
            left: 50%;
            transform: translateX(-50%);
            font-size: 4vw;
            color: #FFF;
            z-index: 2;
            text-align: center;
        }
        #shoot-btn {
            position: absolute;
            bottom: 18vh;      
            left: 50%;
            transform: translateX(-50%);
            width: 16vw;
            height: 16vw;
            border: none;
            border-radius: 50%;
            background-color: transparent;
            background-image: url("images/2/èµ„æº 57@0.5x.webp");
            background-size: 100% 100%;
            cursor: pointer;
            z-index: 99;
        }
        .shoot-text {
            position: absolute;
            bottom: 15.5vh;      
            left: 50%;
            transform: translateX(-50%);
            font-size: 3.5vw;
            color: #FFF;
            z-index: 100;
        }
        /* éŸ³ä¹æŒ‰é’®æ ·å¼ */
        .music-btn {
            position: absolute;
            top: 3vh;
            right: 5vw;
            width: clamp(28px, 7vw, 40px);
            height: clamp(28px, 7vw, 40px);
            border-radius: 50%;
            background-color: transparent;
            background-image: url("images/2/èµ„æº 24@0.5x.webp");
            background-size: 100% 100%;
            cursor: pointer;
            z-index: 99;
            transition: transform 0.2s ease;
        }
        .music-btn.active {
            animation: rotateMusic 3s linear infinite;
        }
        @keyframes rotateMusic {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ========== ç¬¬äºŒé¡µï¼ˆé¢„è§ˆé¡µï¼‰ ========== */
        #preview-page {
            display: none;
            width: 100%;
            height: 100%;
            z-index: 100;
        }
        #preview-img {
            /* æ ¸å¿ƒï¼šä¿æŒæ¯”ä¾‹å¡«å……å®¹å™¨ï¼Œä¸å˜å½¢ã€ä¸åˆ‡å‰²å…³é”®å†…å®¹ */
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* ç¦æ­¢å›¾ç‰‡æ‹‰ä¼¸å˜å½¢ */
            transform: none;
        }
        .btn-group {
            position: absolute;
            bottom: 8vh;      
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10vw;
            z-index: 102;
        }
        .preview-btn {
            border: none;        
            background-color: transparent; 
            padding: 0;          
            text-indent: -9999px;
            overflow: hidden;    
            cursor: pointer;     
        }
        #retake-btn {
            background-image: url("images/2/èµ„æº 51@0.5x.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 24vw;
            height: 8vw;
        }
        #confirm-btn {
            background-image: url("images/2/èµ„æº 52@0.5x.png");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            width: 24vw;
            height: 8vw;
        }

        /* ========== ç¬¬ä¸‰é¡µï¼ˆæœ€ç»ˆé¡µï¼‰ ========== */
        #final-page {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            background: inherit;
        }
        #final-photo {
            /* å’Œé¢„è§ˆå›¾ä¿æŒä¸€è‡´çš„é€‚é…æ–¹å¼ */
            object-fit: cover;
            position: absolute;
            top: 0;            
            left: 0;           
            width: 100%;       
            height: 100%;      
            z-index: 201;
            transform: none;
        }
        .final-content-wrapper {
            position: absolute;
            bottom: 5%;
            left: 0;          
            right: 0;         
            padding: 0 4%;    
            z-index: 202;      
            display: flex;
            align-items: center;
            justify-content: space-between; 
            gap: 3vw; 
            max-width: 100%; 
        }
        .kite-text {
            font-size: clamp(24px, 8vw, 80px);    
            font-weight: 400;   
            color: #000;
            background-color: rgba(255,255,255,0.8); 
            padding: 1.5vw 2vw;  
            line-height: 1.2;  
            white-space: pre-line; 
            display: inline-block;
            font-family: "Microsoft YaHei", "SimHei", "Noto Sans SC Regular", sans-serif;
        }
        .qrcode-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1vw; 
        }
        #qrcode-img {
            width: clamp(60px, 15vw, 120px);
            height: auto;
            border: 2px solid #fff;
            background-color: #fff;
        }
        .qrcode-text {
            font-size: clamp(12px, 3vw, 24px);
            color: #000;
            background-color: rgba(255,255,255,0.8);
            padding: 0.5vw 1vw;
            font-weight: 400;
            white-space: nowrap;
        }
        .final-btn-group {
            position: absolute;
            bottom: 8vh;       
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5vw; 
            align-items: center; 
        }
        .final-btn {
            width: 8vw;       
            height: 8vw;      
            border: none;
            background-color: transparent;
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            background-position: center top; 
            cursor: pointer;
            display: flex;
            flex-direction: column; 
            align-items: center;    
            justify-content: flex-start; 
            font-size: 3vw;      
            color: #333;        
            padding-top: 0;        
            text-indent: 0;        
            overflow: visible;     
            line-height: 1;        
        }
        .final-btn span {
            margin-top: 11vw; 
            display: block;  
        }
        #save-btn {
            background-image: url("images/2/èµ„æº 99@0.5x.webp");
        }
        #share-btn {
            background-image: url("images/2/èµ„æº 100@0.5x.webp");
        }
        #back-btn {
            background-image: url("images/2/èµ„æº 101@0.5x.webp");
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="shoot-page">
            <div class="music-btn"></div>
            <div class="hint">å¯¹å‡†å¤©ç©º<br>ç‚¹å‡»é£ç­æ”¾é£</div>
            <div class="camera-view" id="camera-container">
                <video id="camera-preview" autoplay playsinline muted></video>
                <canvas id="kite-tail-canvas"></canvas>
            </div>
            <img id="kite-img" src="images/2/IMG_2589.png" alt="é£ç­">
            <div id="shoot-btn"></div>
            <div class="shoot-text">ç‚¹å‡»æ‹æ‘„</div>
        </div>

        <div id="preview-page">
            <div class="music-btn"></div>
            <div class="preview-box" id="preview-container">
                <img id="preview-img" alt="æ‹æ‘„çš„ç…§ç‰‡">
            </div>
            <div class="btn-group">
                <div class="preview-btn" id="retake-btn">é‡æ–°æ‹æ‘„</div>
                <div class="preview-btn" id="confirm-btn">ç¡®è®¤é€‰æ‹©</div>
            </div>
        </div>

        <div id="final-page">
            <div class="music-btn"></div>
            <div class="final-photo-area" id="final-photo-container">
                <img id="final-photo" alt="æ‹æ‘„çš„ç…§ç‰‡">
                <div class="final-content-wrapper">
                    <div class="kite-text" id="final-text">æˆ‘çš„
æ½åŠé£ç­</div>
                    <div class="qrcode-container" id="qrcode-container">
                        <img id="qrcode-img" src="images/2/ewm.png" alt="æ‰«ç åˆ¶ä½œäºŒç»´ç ">
                        <div class="qrcode-text" id="qrcode-text">æ‰«ç åˆ¶ä½œ</div>
                    </div>
                </div>
            </div>
            <div class="final-btn-group">
                <button class="final-btn" id="save-btn"><span>ä¿å­˜</span></button>
                <button class="final-btn" id="share-btn"><span>åˆ†äº«</span></button>
                <button class="final-btn" id="back-btn"><span>è¿”å›</span></button>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€ç¼“å­˜ï¼šå­˜å‚¨æ‹æ‘„æ—¶é£ç­çš„åŸå§‹å‚æ•°ï¼ˆå…³é”®ï¼ï¼‰ ==========
        let kiteCaptureParams = null; 
        // æ ¸å¿ƒä¿®æ­£ï¼šè¯»å–å‰ä¸€é¡µä¿å­˜çš„é”®åã€ŒcustomKiteImgã€ï¼ˆå’Œå‰ä¸€é¡µä¿æŒä¸€è‡´ï¼‰
        let customKiteBase64 = localStorage.getItem('customKiteImg');
        const defaultKiteSrc = 'images/2/IMG_2589.png';

        document.addEventListener('DOMContentLoaded', () => {
            // ---------------- DIYé£ç­å¯¼å…¥åŠŸèƒ½ - é”®åç»Ÿä¸€ä¸ºcustomKiteImg ----------------
            const urlParams = new URLSearchParams(window.location.search);
            const encodedKite = urlParams.get('kite');
            const kiteImg = document.getElementById('kite-img');

            // æ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥æ˜¯å¦è¯»å–åˆ°æ•°æ®ï¼ˆå¯åç»­åˆ é™¤ï¼‰
            console.log('ğŸ” è¯»å–åˆ°çš„è‡ªå®šä¹‰é£ç­æ•°æ®ï¼š', customKiteBase64 ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

            // ä¼˜å…ˆçº§ï¼šlocalStorageçš„customKiteImg > URLå‚æ•° > é»˜è®¤å›¾
            if (customKiteBase64) {
                try {
                    kiteImg.src = customKiteBase64;
                    console.log('âœ… æˆåŠŸåŠ è½½localStorageä¸­çš„è‡ªå®šä¹‰é£ç­');
                } catch (err) {
                    console.warn('âŒ localStorageè‡ªå®šä¹‰é£ç­åŠ è½½å¤±è´¥:', err);
                    alert('è‡ªå®šä¹‰é£ç­åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é£ç­~');
                    kiteImg.src = defaultKiteSrc;
                }
            } else if (encodedKite) {
                try {
                    const decodedKite = decodeURIComponent(encodedKite);
                    kiteImg.src = decodedKite;
                    customKiteBase64 = decodedKite;
                    console.log('âœ… æˆåŠŸåŠ è½½URLå‚æ•°ä¸­çš„è‡ªå®šä¹‰é£ç­');
                } catch (err) {
                    console.warn('âŒ URLè‡ªå®šä¹‰é£ç­åŠ è½½å¤±è´¥:', err);
                    alert('è‡ªå®šä¹‰é£ç­åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é£ç­~');
                    kiteImg.src = defaultKiteSrc;
                }
            } else {
                console.log('â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰é£ç­ï¼Œä½¿ç”¨é»˜è®¤å›¾');
                kiteImg.src = defaultKiteSrc;
            }

            // é£ç­åŠ è½½å¤±è´¥çš„å…œåº•å¤„ç†
            kiteImg.onerror = function () {
                console.error(`âŒ é£ç­å›¾ç‰‡åŠ è½½å¤±è´¥: ${this.src}`);
                this.src = defaultKiteSrc;
            };

            // ---------------- éŸ³ä¹æ’­æ”¾åŠŸèƒ½ï¼ˆä¿æŒä¸å˜ï¼‰ ----------------
            let bgMusic = null;
            let isMusicPlaying = false;
            const musicBtns = document.querySelectorAll('.music-btn');

            function initAudio() {
                if (bgMusic) return;
                bgMusic = new Audio('music.m4a');
                bgMusic.loop = true;
                bgMusic.muted = true;
                bgMusic.load();
                bgMusic.play().then(() => {
                    bgMusic.pause();
                    bgMusic.muted = false;
                }).catch(err => console.log("éŸ³é¢‘é¢„åŠ è½½ï¼š", err));
            }

            document.addEventListener('touchstart', initAudio, { once: true });

            function toggleMusic() {
                if (!bgMusic) initAudio();
                try {
                    if (isMusicPlaying) {
                        bgMusic.pause();
                        musicBtns.forEach(btn => btn.classList.remove('active'));
                    } else {
                        bgMusic.play().catch(err => {
                            console.error('éŸ³ä¹æ’­æ”¾å¤±è´¥:', err);
                            bgMusic.load();
                            setTimeout(() => bgMusic.play(), 100);
                        });
                        musicBtns.forEach(btn => btn.classList.add('active'));
                    }
                    isMusicPlaying = !isMusicPlaying;
                } catch (e) {
                    console.error('éŸ³ä¹æ§åˆ¶å¼‚å¸¸:', e);
                }
            }

            musicBtns.forEach(btn => {
                btn.addEventListener('click', toggleMusic);
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    toggleMusic();
                }, { passive: false });
            });

            document.addEventListener('visibilitychange', () => {
                if (document.hidden && isMusicPlaying) {
                    bgMusic.pause();
                    musicBtns.forEach(btn => btn.classList.remove('active'));
                    isMusicPlaying = false;
                }
            });
        });

        // ========== DOMå…ƒç´ è·å–ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        const shootPage = document.getElementById('shoot-page');
        const previewPage = document.getElementById('preview-page');
        const finalPage = document.getElementById('final-page');
        const cameraPreview = document.getElementById('camera-preview');
        const kiteImg = document.getElementById('kite-img');
        const shootBtn = document.getElementById('shoot-btn');
        const previewImg = document.getElementById('preview-img');
        const retakeBtn = document.getElementById('retake-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const cameraContainer = document.getElementById('camera-container');
        const finalPhoto = document.getElementById('final-photo');
        const finalPhotoContainer = document.getElementById('final-photo-container');
        const saveBtn = document.getElementById('save-btn');
        const shareBtn = document.getElementById('share-btn');
        const backBtn = document.getElementById('back-btn');
        const finalText = document.getElementById('final-text');
        const qrcodeImg = document.getElementById('qrcode-img');
        const qrcodeText = document.getElementById('qrcode-text');
        const tailCanvas = document.getElementById('kite-tail-canvas');
        const tailCtx = tailCanvas.getContext('2d');

        let isCameraReady = false;
        let captureCanvas = null;
        let previewDataUrl = '';
        let videoNativeSize = { width: 0, height: 0 };
        let containerRectCache = null;
        const dpr = window.devicePixelRatio || 1;

        // ========== é£ç­çº¿å‚æ•°ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        const kiteLineConfig = {
            tailXOffset: 0.45,    
            tailYOffset: 0.55,     
            tailLengthRatio: 4.2, 
            angle1: 3 * Math.PI / 4,  
            angle2: 2 * Math.PI / 3,   
            endAngle: 3 * Math.PI / 4, 
            wiggleSpeed: 0.012,   
            wiggleAmplitude: 12,  
            wiggleXMultiplier: -1.5,   
            wiggleYMultiplier: 1.8,    
            cp1XMultiplier: 0.8,  
            cp1YMultiplier: 0.8,  
            cp2XMultiplier: 1.5,  
            cp2YMultiplier: 1.5   
        };
        let tailWiggle = { offsetX: 0, offsetY: 0 };

        // ========== é£ç­çº¿ç»˜åˆ¶ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        function resizeTailCanvas() {
            const containerRect = cameraContainer.getBoundingClientRect();
            tailCanvas.width = containerRect.width * dpr;
            tailCanvas.height = containerRect.height * dpr;
            tailCanvas.style.width = `${containerRect.width}px`;
            tailCanvas.style.height = `${containerRect.height}px`;
            tailCtx.scale(dpr, dpr);
        }
        resizeTailCanvas();
        window.addEventListener('resize', resizeTailCanvas);

        function calculateKiteLineParams(kiteRect) {
            if (!kiteRect || kiteRect.width === 0 || kiteRect.height === 0) {
                console.error('é£ç­å…ƒç´ å°ºå¯¸å¼‚å¸¸:', kiteRect);
                return {
                    startX: 0, startY: 0, cp1X: 0, cp1Y: 0, cp2X: 0, cp2Y: 0, endX: 0, endY: 0,
                    rotateAngle: 15 * Math.PI / 180, tailLength: 0, kiteRect: {}, cameraRect: {}
                };
            }
            
            const cameraRect = cameraContainer.getBoundingClientRect();
            const relativeKiteX = kiteRect.left - cameraRect.left;
            const relativeKiteY = kiteRect.top - cameraRect.top;
            
            const kiteTailX = relativeKiteX + (kiteRect.width * kiteLineConfig.tailXOffset);
            const kiteTailY = relativeKiteY + (kiteRect.height * kiteLineConfig.tailYOffset);
            
            const transform = window.getComputedStyle(kiteImg).transform;
            let rotateAngle = 15 * Math.PI / 180;
            if (transform !== 'none' && transform !== 'matrix(1, 0, 0, 1, 0, 0)') {
                try {
                    const nums = transform.match(/matrix(3d)?\(([^)]+)\)/)[2].split(',').map(Number);
                    const a = nums[0] || 1, b = nums[1] || 0;
                    rotateAngle = Math.atan2(b, a);
                } catch (e) {
                    console.warn('è§£ætransformå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ—‹è½¬è§’åº¦:', e);
                    rotateAngle = 15 * Math.PI / 180;
                }
            }

            tailWiggle.offsetX = Math.sin(Date.now() * kiteLineConfig.wiggleSpeed) * 
                                 kiteLineConfig.wiggleAmplitude * kiteLineConfig.wiggleXMultiplier;
            tailWiggle.offsetY = Math.cos(Date.now() * kiteLineConfig.wiggleSpeed * 0.8) * 
                                 kiteLineConfig.wiggleAmplitude * kiteLineConfig.wiggleYMultiplier;
            
            const tailLength = kiteRect.width * kiteLineConfig.tailLengthRatio;
            const startX = kiteTailX;
            const startY = kiteTailY;
            const angle1 = rotateAngle + kiteLineConfig.angle1;
            const angle2 = rotateAngle + kiteLineConfig.angle2;
            
            const cp1X = startX + Math.cos(angle1) * tailLength * 0.2 + tailWiggle.offsetX * kiteLineConfig.cp1XMultiplier;
            const cp1Y = startY + Math.sin(angle1) * tailLength * 0.2 + tailWiggle.offsetY * kiteLineConfig.cp1YMultiplier;
            const cp2X = startX + Math.cos(angle2) * tailLength * 0.8 + tailWiggle.offsetX * kiteLineConfig.cp2XMultiplier;
            const cp2Y = startY + Math.sin(angle2) * tailLength * 0.8 + tailWiggle.offsetY * kiteLineConfig.cp2YMultiplier;
            const endX = startX + Math.cos(rotateAngle + kiteLineConfig.endAngle) * tailLength;
            const endY = startY + Math.sin(rotateAngle + kiteLineConfig.endAngle) * tailLength;

            return {
                startX, startY, cp1X, cp1Y, cp2X, cp2Y, endX, endY,
                rotateAngle, tailLength, kiteRect, cameraRect
            };
        }

        function drawKiteTail() {
            try {
                tailCtx.clearRect(0, 0, tailCanvas.width / dpr, tailCanvas.height / dpr);
                const kiteRect = kiteImg.getBoundingClientRect();
                const lineParams = calculateKiteLineParams(kiteRect);

                tailCtx.beginPath();
                tailCtx.moveTo(lineParams.startX, lineParams.startY);
                tailCtx.bezierCurveTo(
                    lineParams.cp1X, lineParams.cp1Y,
                    lineParams.cp2X, lineParams.cp2Y,
                    lineParams.endX, lineParams.endY
                );
                tailCtx.strokeStyle = '#000000';
                tailCtx.lineWidth = Math.max(1, kiteRect.width * 0.004);
                tailCtx.lineCap = 'round';
                tailCtx.stroke();
            } catch (e) {
                console.warn('ç»˜åˆ¶é£ç­çº¿å¤±è´¥:', e);
            }
            requestAnimationFrame(drawKiteTail);
        }
        drawKiteTail();

        // ========== ç›¸æœºåˆå§‹åŒ–ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        function getCoverDrawParams(videoW, videoH, containerW, containerH) {
            const videoRatio = videoW / videoH;
            const containerRatio = containerW / containerH;

            let drawWidth, drawHeight, offsetX, offsetY;

            if (videoRatio > containerRatio) {
                drawHeight = containerH;
                drawWidth = videoW * (containerH / videoH);
                offsetX = (drawWidth - containerW) / 2;
                offsetY = 0;
            } else {
                drawWidth = containerW;
                drawHeight = videoH * (containerW / videoW);
                offsetX = 0;
                offsetY = (drawHeight - containerH) / 2;
            }

            return {
                sx: 0,
                sy: 0,
                sw: videoW,
                sh: videoH,
                dx: -offsetX,
                dy: -offsetY,
                dw: drawWidth,
                dh: drawHeight
            };
        }

        async function initCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒç›¸æœºåŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chrome/Edge/Firefoxç­‰ç°ä»£æµè§ˆå™¨');
                    return;
                }

                if (window.location.protocol === 'file:') {
                    alert('è¯·åœ¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼ˆå¦‚VSCode Live Serverï¼‰ï¼Œç¦æ­¢ç›´æ¥åŒå‡»HTMLæ–‡ä»¶');
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                });

                cameraPreview.srcObject = stream;
                
                cameraPreview.onloadedmetadata = () => {
                    videoNativeSize.width = cameraPreview.videoWidth;
                    videoNativeSize.height = cameraPreview.videoHeight;
                    isCameraReady = true;
                    console.log('âœ… ç›¸æœºåˆå§‹åŒ–æˆåŠŸï¼Œåˆ†è¾¨ç‡:', videoNativeSize);
                };

                cameraPreview.onplay = () => {
                    isCameraReady = true;
                };

                cameraPreview.onerror = (e) => {
                    console.error('ç›¸æœºé¢„è§ˆå¼‚å¸¸:', e);
                    isCameraReady = false;
                    alert('ç›¸æœºé¢„è§ˆåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦æ­£å¸¸');
                };

            } catch (err) {
                let errMsg = '';
                if (err.name === 'NotAllowedError') {
                    errMsg = 'è¯·å…è®¸ç›¸æœºæƒé™ï¼ˆåœ°å€æ å·¦ä¾§ç›¸æœºå›¾æ ‡â†’å…è®¸ï¼‰ï¼Œå¦åˆ™æ— æ³•ä½¿ç”¨æ‹æ‘„åŠŸèƒ½';
                } else if (err.name === 'NotFoundError') {
                    errMsg = 'æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦è¿æ¥æ­£å¸¸';
                } else if (err.name === 'NotSupportedError') {
                    errMsg = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒç›¸æœºè®¿é—®ï¼Œè¯·åœ¨HTTPSæˆ–æœ¬åœ°æœåŠ¡å™¨ç¯å¢ƒä¸‹è¿è¡Œ';
                } else {
                    errMsg = 'ç›¸æœºåˆå§‹åŒ–å¤±è´¥ï¼š' + err.message;
                }
                alert(errMsg);
                console.error('ç›¸æœºåˆå§‹åŒ–é”™è¯¯:', err);
                isCameraReady = false;
            }
        }

        // ========== é£ç­ç‚¹å‡»äº‹ä»¶ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        kiteImg.addEventListener('click', () => {
            if (!kiteImg.classList.contains('flying')) {
                kiteImg.classList.add('flying');
                void kiteImg.offsetWidth;
            }
        });

        // ========== æ‹æ‘„é€»è¾‘ï¼ˆä¼˜åŒ–canvaså°ºå¯¸ï¼Œé¿å…å˜å½¢ï¼‰ ==========
        shootBtn.addEventListener('click', async () => {
            if (!isCameraReady) {
                alert('ç›¸æœºè¿˜æœªå°±ç»ªï¼è¯·å…ˆå…è®¸ç›¸æœºæƒé™æˆ–ç­‰å¾…åŠ è½½å®Œæˆ');
                initCamera();
                return;
            }

            if (!videoNativeSize.width || !videoNativeSize.height) {
                alert('ç›¸æœºåˆ†è¾¨ç‡å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            if (!kiteImg.complete || kiteImg.naturalWidth === 0) {
                alert('é£ç­å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥å›¾ç‰‡è·¯å¾„æˆ–åˆ·æ–°é¡µé¢');
                return;
            }

            try {
                kiteImg.style.animationPlayState = 'paused';
                containerRectCache = cameraContainer.getBoundingClientRect();
                
                if (containerRectCache.width === 0 || containerRectCache.height === 0) {
                    alert('ç›¸æœºå®¹å™¨å°ºå¯¸å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥é¡µé¢å¸ƒå±€');
                    kiteImg.style.animationPlayState = 'running';
                    return;
                }

                const containerW = containerRectCache.width;
                const containerH = containerRectCache.height;

                // æ ¸å¿ƒä¼˜åŒ–ï¼šcanvaså°ºå¯¸å’Œå®¹å™¨ç‰©ç†å°ºå¯¸ä¸€è‡´ï¼Œé¿å…ç¼©æ”¾å˜å½¢
                captureCanvas = document.createElement('canvas');
                captureCanvas.width = containerW * dpr;
                captureCanvas.height = containerH * dpr;
                const ctx = captureCanvas.getContext('2d');
                ctx.scale(dpr, dpr);
                // æ¸…ç©ºcanvasèƒŒæ™¯ï¼Œé¿å…æ®‹ç•™
                ctx.fillStyle = '#fff8e6';
                ctx.fillRect(0, 0, containerW, containerH);

                try {
                    const drawParams = getCoverDrawParams(
                        videoNativeSize.width, 
                        videoNativeSize.height, 
                        containerW, 
                        containerH
                    );
                    ctx.drawImage(
                        cameraPreview,
                        drawParams.sx, drawParams.sy, drawParams.sw, drawParams.sh,
                        drawParams.dx, drawParams.dy, drawParams.dw, drawParams.dh
                    );
                } catch (e) {
                    console.error('ç»˜åˆ¶ç›¸æœºç”»é¢å¤±è´¥:', e);
                    ctx.fillStyle = '#fff8e6';
                    ctx.fillRect(0, 0, containerW, containerH);
                }

                const kiteRect = kiteImg.getBoundingClientRect();
                
                if (kiteRect.width === 0 || kiteRect.height === 0) {
                    alert('é£ç­å…ƒç´ å°ºå¯¸å¼‚å¸¸ï¼Œæ— æ³•æ‹æ‘„');
                    kiteImg.style.animationPlayState = 'running';
                    return;
                }

                const kiteOffsetX = kiteRect.left - containerRectCache.left;
                const kiteOffsetY = kiteRect.top - containerRectCache.top;
                const kiteWidth = kiteRect.width;
                const kiteHeight = kiteRect.height;

                let rotateAngle = 15 * Math.PI / 180;
                let scale = 1;
                try {
                    const transform = window.getComputedStyle(kiteImg).transform;
                    if (transform !== 'none' && transform !== 'matrix(1, 0, 0, 1, 0, 0)') {
                        const nums = transform.match(/matrix(3d)?\(([^)]+)\)/)[2].split(',').map(Number);
                        const a = nums[0] || 1, b = nums[1] || 0;
                        rotateAngle = Math.atan2(b, a);
                        scale = Math.sqrt(a * a + b * b);
                    }
                } catch (e) {
                    console.warn('è§£æé£ç­transformå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', e);
                    rotateAngle = 15 * Math.PI / 180;
                    scale = 1;
                }

                kiteCaptureParams = {
                    offsetX: kiteOffsetX,
                    offsetY: kiteOffsetY,
                    width: kiteWidth,
                    height: kiteHeight,
                    rotateAngle: rotateAngle,
                    scale: scale,
                    containerW: containerW,
                    containerH: containerH
                };

                try {
                    const lineParams = calculateKiteLineParams(kiteRect);
                    ctx.beginPath();
                    ctx.moveTo(lineParams.startX, lineParams.startY);
                    ctx.bezierCurveTo(
                        lineParams.cp1X, lineParams.cp1Y,
                        lineParams.cp2X, lineParams.cp2Y,
                        lineParams.endX, lineParams.endY
                    );
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = Math.max(1, kiteWidth * 0.004);
                    ctx.lineCap = 'round';
                    ctx.stroke();
                } catch (e) {
                    console.warn('ç»˜åˆ¶é£ç­çº¿å¤±è´¥:', e);
                }

                try {
                    ctx.save();
                    ctx.translate(
                        kiteCaptureParams.offsetX + kiteCaptureParams.width / 2,
                        kiteCaptureParams.offsetY + kiteCaptureParams.height / 2
                    );
                    ctx.rotate(kiteCaptureParams.rotateAngle);
                    ctx.scale(kiteCaptureParams.scale, kiteCaptureParams.scale);
                    ctx.drawImage(
                        kiteImg,
                        -kiteCaptureParams.width / 2,
                        -kiteCaptureParams.height / 2,
                        kiteCaptureParams.width,
                        kiteCaptureParams.height
                    );
                    ctx.restore();
                } catch (e) {
                    console.error('ç»˜åˆ¶é£ç­å¤±è´¥:', e);
                    alert('ç»˜åˆ¶é£ç­å¤±è´¥ï¼Œè¯·é‡è¯•');
                    kiteImg.style.animationPlayState = 'running';
                    return;
                }

                // ç”Ÿæˆé¢„è§ˆå›¾æ—¶æŒ‡å®šè´¨é‡ï¼Œé¿å…å‹ç¼©å¯¼è‡´çš„å˜å½¢
                previewDataUrl = captureCanvas.toDataURL('image/png', 1.0);
                previewImg.src = previewDataUrl;
                finalPhoto.src = previewDataUrl;

                shootPage.style.display = 'none';
                previewPage.style.display = 'block';

            } catch (drawErr) {
                alert('æ‹æ‘„å¤±è´¥ï¼š' + drawErr.message);
                console.error('æ‹æ‘„è¿‡ç¨‹å¼‚å¸¸:', drawErr);
                kiteImg.style.animationPlayState = 'running';
            }
        });

        // ========== é‡æ–°æ‹æ‘„ï¼šå¤ç”¨è‡ªå®šä¹‰é£ç­ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        retakeBtn.addEventListener('click', () => {
            kiteImg.classList.remove('flying');
            kiteImg.style.animationPlayState = 'running';
            void kiteImg.offsetWidth;
            previewPage.style.display = 'none';
            shootPage.style.display = 'block';
            captureCanvas = null;
            previewDataUrl = '';
            containerRectCache = null;
            kiteCaptureParams = null;
            
            // é‡æ–°è®¾ç½®è‡ªå®šä¹‰é£ç­
            if (customKiteBase64) {
                kiteImg.src = customKiteBase64;
            }
        });

        // ========== ç¡®è®¤è¿›å…¥æœ€ç»ˆé¡µï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        confirmBtn.addEventListener('click', () => {
            if (!previewDataUrl) {
                alert('æš‚æ— æ‹æ‘„çš„ç…§ç‰‡ï¼');
                return;
            }
            previewPage.style.display = 'none';
            finalPage.style.display = 'block';
        });

        // ========== ä¿å­˜é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        saveBtn.addEventListener('click', async () => {
            if (!previewDataUrl || !containerRectCache || !kiteCaptureParams) {
                alert('æš‚æ— å¯ä¿å­˜çš„ç…§ç‰‡ï¼');
                return;
            }

            try {
                const saveCanvas = document.createElement('canvas');
                saveCanvas.width = kiteCaptureParams.containerW * dpr;
                saveCanvas.height = kiteCaptureParams.containerH * dpr;
                const ctx = saveCanvas.getContext('2d');
                ctx.scale(dpr, dpr);

                const previewImgObj = new Image();
                previewImgObj.crossOrigin = 'anonymous';
                previewImgObj.src = previewDataUrl;
                await new Promise((resolve) => {
                    previewImgObj.onload = resolve;
                    previewImgObj.onerror = () => {
                        console.error('åŠ è½½é¢„è§ˆå›¾å¤±è´¥');
                        resolve();
                    };
                });
                ctx.drawImage(previewImgObj, 0, 0, kiteCaptureParams.containerW, kiteCaptureParams.containerH);

                ctx.save();
                ctx.translate(
                    kiteCaptureParams.offsetX + kiteCaptureParams.width / 2,
                    kiteCaptureParams.offsetY + kiteCaptureParams.height / 2
                );
                ctx.rotate(kiteCaptureParams.rotateAngle);
                ctx.scale(kiteCaptureParams.scale, kiteCaptureParams.scale);
                ctx.drawImage(
                    kiteImg,
                    -kiteCaptureParams.width / 2,
                    -kiteCaptureParams.height / 2,
                    kiteCaptureParams.width,
                    kiteCaptureParams.height
                );
                ctx.restore();

                const finalContainerRect = finalPhotoContainer.getBoundingClientRect();
                const scaleRatioW = kiteCaptureParams.containerW / finalContainerRect.width;
                const scaleRatioH = kiteCaptureParams.containerH / finalContainerRect.height;

                const textRect = finalText.getBoundingClientRect();
                const textX = textRect.left - finalContainerRect.left * scaleRatioW;
                const textY = textRect.top - finalContainerRect.top * scaleRatioH;
                const textW = textRect.width * scaleRatioW;
                const textH = textRect.height * scaleRatioH;

                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.fillRect(textX, textY, textW, textH);

                const textLines = finalText.textContent.trim().split('\n');
                const fontSize = parseFloat(getComputedStyle(finalText).fontSize) * scaleRatioW;
                ctx.font = `400 ${fontSize}px "Microsoft YaHei", "SimHei", sans-serif`;
                ctx.fillStyle = '#000';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                const paddingX = parseFloat(getComputedStyle(finalText).paddingLeft) * scaleRatioW;
                const paddingY = parseFloat(getComputedStyle(finalText).paddingTop) * scaleRatioH;
                
                if (textLines.length > 0) {
                    ctx.fillText(textLines[0] || 'æˆ‘çš„', textX + paddingX, textY + paddingY);
                }
                if (textLines.length > 1) {
                    ctx.fillText(textLines[1] || 'æ½åŠé£ç­', textX + paddingX, textY + paddingY + fontSize * 1.2);
                }

                const qrImgRect = qrcodeImg.getBoundingClientRect();
                const qrImgX = (qrImgRect.left - finalContainerRect.left) * scaleRatioW;
                const qrImgY = (qrImgRect.top - finalContainerRect.top) * scaleRatioH;
                const qrImgW = qrImgRect.width * scaleRatioW;
                const qrImgH = qrImgRect.height * scaleRatioH;

                const qrImgObj = new Image();
                qrImgObj.crossOrigin = 'anonymous';
                qrImgObj.src = qrcodeImg.src;
                await new Promise((resolve) => {
                    qrImgObj.onload = () => {
                        ctx.drawImage(qrImgObj, qrImgX, qrImgY, qrImgW, qrImgH);
                        resolve();
                    };
                    qrImgObj.onerror = () => {
                        console.warn('äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥');
                        resolve();
                    };
                });

                const qrTextRect = qrcodeText.getBoundingClientRect();
                const qrTextX = (qrTextRect.left - finalContainerRect.left) * scaleRatioW;
                const qrTextY = (qrTextRect.top - finalContainerRect.top) * scaleRatioH;
                const qrTextW = qrTextRect.width * scaleRatioW;
                const qrTextH = qrTextRect.height * scaleRatioH;

                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.fillRect(qrTextX, qrTextY, qrTextW, qrTextH);

                const qrFontSize = parseFloat(getComputedStyle(qrcodeText).fontSize) * scaleRatioW;
                ctx.font = `400 ${qrFontSize}px "Microsoft YaHei", "SimHei", sans-serif`;
                ctx.fillStyle = '#000';
                const qrPaddingX = parseFloat(getComputedStyle(qrcodeText).paddingLeft) * scaleRatioW;
                const qrPaddingY = parseFloat(getComputedStyle(qrcodeText).paddingTop) * scaleRatioW;
                ctx.fillText(qrcodeText.textContent.trim(), qrTextX + qrPaddingX, qrTextY + qrPaddingY);

                const finalDataUrl = saveCanvas.toDataURL('image/png', 1.0);
                const a = document.createElement('a');
                a.href = finalDataUrl;
                a.download = `æˆ‘çš„æ½åŠé£ç­_${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                alert('ä¿å­˜æˆåŠŸï¼é£ç­ä¸é¢„è§ˆå›¾å®Œå…¨ä¸€è‡´ï½');
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
                console.error('ä¿å­˜è¿‡ç¨‹å¼‚å¸¸:', err);
            }
        });

        // ========== è¿”å›/åˆ†äº«é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ ==========
        backBtn.addEventListener('click', () => {
            finalPage.style.display = 'none';
            previewPage.style.display = 'block';
        });

        shareBtn.addEventListener('click', () => {
            alert('åˆ†äº«åŠŸèƒ½æš‚æœªå¼€æ”¾');
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ç›¸æœº
        window.addEventListener('load', () => {
            initCamera(); // ç«‹å³åˆå§‹åŒ–ç›¸æœºï¼Œé¿å…å»¶è¿Ÿå¯¼è‡´çš„å°ºå¯¸é—®é¢˜
            setTimeout(initAudio, 500);
        });

        // å¤„ç†é¡µé¢å°ºå¯¸å˜åŒ–ï¼ˆä¼˜åŒ–é€‚é…ï¼‰
        window.addEventListener('resize', () => {
            if (isCameraReady) {
                containerRectCache = cameraContainer.getBoundingClientRect();
                // åŒæ­¥æ›´æ–°é¢„è§ˆé¡µ/æœ€ç»ˆé¡µå®¹å™¨å°ºå¯¸
                if (previewPage.style.display === 'block') {
                    const previewRect = cameraContainer.getBoundingClientRect();
                    const previewContainer = document.getElementById('preview-container');
                    previewContainer.style.width = `${previewRect.width}px`;
                    previewContainer.style.height = `${previewRect.height}px`;
                }
                if (finalPage.style.display === 'block') {
                    const finalRect = cameraContainer.getBoundingClientRect();
                    const finalContainer = document.getElementById('final-photo-container');
                    finalContainer.style.width = `${finalRect.width}px`;
                    finalContainer.style.height = `${finalRect.height}px`;
                }
            }
        });
    </script>
</body>
</html>